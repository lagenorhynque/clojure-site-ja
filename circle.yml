machine:
  timezone: Asia/Tokyo
  java:
    version: openjdk8
  environment:
    PATH: /home/$USER/perl5/bin:$PATH
    PERL_CPANM_OPT: "--local-lib=/home/$USER/perl5"
    PERL5LIB: "/home/$USER/perl5/lib/perl5:$PERL5LIB"

dependencies:
  cache_directories:
    - ~/.pyenv/versions/3.5.1
    - ~/jbake
    - ~/redpen
    - ~/perl5
    - local
  pre:
    - sudo apt-get update; sudo apt-get install po4a
    - curl -L https://cpanmin.us | perl - App::cpanminus
    - |
      git clone https://github.com/mquinson/po4a.git
      cd po4a
      git checkout -b v0.52 refs/tags/v0.52
      perl Build.PL --install_base ~/perl5
      yes | ./Build installdeps
      ./Build
      ./Build install
    - if [[ ! -e ~/redpen ]]; then curl -L -o redpen.tar.gz https://github.com/redpen-cc/redpen/releases/download/redpen-1.9.0/redpen-1.9.0.tar.gz && tar xvf redpen.tar.gz && mv redpen-distribution-1.9.0 ~/redpen; fi
    - if [[ ! -e ~/jbake ]]; then curl -o jbake.zip http://cdn.cognitect.com/clojure.org/jbake-2.5.0-SNAPSHOT-bin.zip && unzip -o jbake.zip && mv jbake-2.5.0-SNAPSHOT ~/jbake; fi
    - if [[ ! -e ~/.pyenv/versions/3.5.1 ]]; then yes | pyenv install 3.5.1; fi
    - pyenv local 3.5.1
  post:
    - pip install -r python-packages.txt

test:
  override:
    - make test -e REDPEN_CMD=~/redpen/bin/redpen
  post:
    - mkdir $CIRCLE_ARTIFACTS/translation-result
    - mv ./ja $CIRCLE_ARTIFACTS/translation-result

deployment:
  production:
    branch: master
    commands:
      - make publish -e JBAKE_CMD=~/jbake/bin/jbake
